{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags l10n %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/swiper-bundle.min.css' %}">
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/style.css' %}?v=1.6.0">
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/colors/color-1.css' %}">

    <style>
    /* --- SIZE SELECTION (2 Boxes Side-by-Side) --- */
    .option-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem; 
      max-width: 100%;
      margin-bottom: 1.5rem; 
      padding: 8px 0;
    }
    .opt-size {
      position: relative; 
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border: 2px solid var(--scroll-bar-color);
      border-radius: .5rem;
      padding: 1rem;
      cursor: pointer;
      background: var(--container-color);
      color: var(--text-color);
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .opt-size:hover { border-color: var(--text-color); }
    .opt-size.is-active {
      background: #575757; color: #fff; border-color: #575757;
    }
    .opt-size input { position: absolute; opacity: 0; width: 0; height: 0; }

    /* --- FINISH SELECTION (One Single Split Box) --- */
    .finish-box {
        display: flex;
        flex-direction: column;
        border: 2px solid var(--scroll-bar-color);
        border-radius: .5rem;
        overflow: hidden; 
        margin-bottom: 1.5rem;
        background-color: var(--container-color);
    }

    .opt-finish {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.2rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid var(--scroll-bar-color); 
        color: var(--text-color);
        transition: background 0.2s ease;
        font-weight: 400;
    }

    /* Remove divider from last item */
    .opt-finish:last-child {
        border-bottom: none;
    }

    .opt-finish:hover {
        background-color: var(--body-color);
    }

    .opt-finish.is-active {
        background: #575757;
        color: #fff;
    }
    
    .finish-text {
        font-size: var(--normal-font-size);
    }

    .opt-finish input { position: absolute; opacity: 0; }

    /* --- CHECKBOX (Borders) --- */
    .checkbox-container {
        display: flex;
        align-items: center;
        margin-top: 1rem;
        cursor: pointer;
        user-select: none;
    }
    .checkbox-container input {
        width: 1.5rem; 
        height: 1.5rem; 
        margin-right: 0.75rem; 
        accent-color: var(--first-color);
        cursor: pointer;
    }
    .checkbox-label {
        font-size: var(--normal-font-size);
        color: var(--title-color);
    }

    /* --- BADGES --- */
    .shipping-badge {
        position: absolute; top: -8px; right: -8px;
        background: #e74c3c; border: 1px solid #e74c3c;
        color: white; font-size: 0.55rem; font-weight: 600;
        padding: 0.15rem 0.35rem; border-radius: 0.2rem;
        text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 10;
    }

    .recommended-badge {
        position: absolute; top: -8px; left: -8px; 
        background: #f39c12; border: 1px solid #f39c12;
        color: white; font-size: 0.55rem; font-weight: 600;
        padding: 0.15rem 0.35rem; border-radius: 0.2rem;
        text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 10;
        display: none; 
    }
    </style>
{% endblock %}

{% block content %}

<main class="main">
    <section class="details section container">
        <h2 class="breadcrumb__title">Details Page</h2>
        <h3 class="breadcrumb__subtitle"><a href="{% pageurl page.get_parent %}">Shop</a> > <span>{{ page.title }}</span></h3>

        <div class="details__container grid">
            <div class="product__images grid">
                {% if page.product_image %}
                    <div class="product__img">
                        {% image page.product_image height-1000 alt=page.title %}
                    </div>
                {% endif %}
            </div>

            <div class="product__info">
                {% if page.orientation %}
                    <p class="details__subtitle">{{ page.orientation | title }}</p>
                {% endif %}
                
                <h3 class="details__title">{{ page.title }}</h3>

                <div class="details__prices">
                    <span class="details__price" id="product-price">--.-- €</span>
                    <span id="free-shipping-text" style="display: none; color: #e74c3c; font-size: var(--small-font-size); font-weight: var(--font-medium); margin-left: 1rem; background: rgba(231, 76, 60, 0.1); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
                        Free Shipping
                    </span>
                </div>

                <div class="details__description" style="margin-top: var(--mb-2);">
                    <p style="margin-bottom: 1rem; font-size: var(--small-font-size); color: var(--text-color);">
                        Produced on the finest photo paper, each print captures every detail with stunning clarity. 
                        Choose between 60x40 cm and 45x30 cm formats, available with optional 
                        Alu-Composite mounting or Shadow Gap frames.
                    </p>
                    <div class="simple-description">
                        {{ page.description_text | linebreaks }}
                    </div>
                </div>

                <form action="{% url 'add_to_cart' product_id=page.id %}" method="POST" id="add-to-cart-form">
                    {% csrf_token %}
                    
                    {% with all_variants as variants %}
                        {% if variants %}
                            <div class="option-toggle" role="group" aria-label="Größe">
                                {% for variant in variants %}
                                <label class="opt-size {% if forloop.first %}is-active{% endif %}" id="size-label-{{ variant.id }}">
                                    <input type="radio" name="size_variant" value="{{ variant.id }}" {% if forloop.first %}checked{% endif %}>
                                    <span>{{ variant.size_name }}</span>
                                    
                                    {% if "60x40" in variant.size_name %}
                                        <div class="shipping-badge">Free Shipping</div>
                                    {% endif %}
                                    
                                    <div class="recommended-badge" id="rec-badge-{{ variant.id }}">Recommended</div>
                                </label>
                                {% endfor %}
                            </div>
                            
                            <div class="finish-box" role="group" aria-label="Finish">
                                <label class="opt-finish is-active">
                                    <input type="radio" name="finish_variant" value="fine_art" checked>
                                    <span class="finish-text" id="text-fine">Fine Art Print</span>
                                </label>
                                <label class="opt-finish">
                                    <input type="radio" name="finish_variant" value="alu_dibond">
                                    <span class="finish-text" id="text-alu">Alu-Composite Frameless</span>
                                </label>
                                <label class="opt-finish">
                                    <input type="radio" name="finish_variant" value="shadow_gap">
                                    <span class="finish-text" id="text-shadow">Alu-Composite + Shadow Gap Frame</span>
                                </label>
                            </div>

                            <label class="checkbox-container">
                                <input type="checkbox" name="add_borders" id="borders-checkbox" value="true">
                                <span class="checkbox-label">Add White Borders</span>
                            </label>
                        
                        {% else %}
                            <p>Dieses Produkt ist derzeit nicht verfügbar.</p>
                        {% endif %}
                    {% endwith %}

                    <button type="submit" class="button" id="add-to-cart-btn" style="width: 100%; margin-top: var(--mb-1-5);">Add To Cart</button>
                </form>

            </div>
        </div>
    </section>

    <section class="related__products section">
        <h2 class="section__title">Related Products</h2>
        <div class="new__container container">
            <div class="swiper new-swiper">
                <div class="swiper-wrapper">
                    {% for product in related_products %}
                    <div class="shop__content swiper-slide">
                        <a href="{% pageurl product %}" class="related-product__main-link">
                            {% if product.product_image %}
                                {% image product.product_image width-300 alt=product.title class="shop__img" %}
                            {% endif %}
                            <h3 class="shop__title">{{ product.title }}</h3>
                        </a>
                        <div class="shop__prices">
                            {% with all_variants|first as first_variant %}
                                {% if first_variant %}
                                    <span class="shop__price">From {{ first_variant.price_fine_art|default:"0.00"|unlocalize }} €</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="footer section">
    <div class="footer__container container grid">
        <div class="footer__content">
            <a href="#" class="footer__logo">
                    <img src="{% static 'home/assets/images/logo_cumulophib.png' %}" alt="Logo" style="height: 2.5em; vertical-align: middle; margin-right: 0.5em;">
            </a>
            <p class="footer__description"> Danke! </p>
            <div class="footer__social">
                <a href="https://www.instagram.com/cumulophib/" class="footer__social-link"><i class="bx bxl-instagram-alt"></i></a>
            </div>
        </div>
    </div>
    <span class="footer__copy">&#169; Crypticalcoder. All rights reserved</span>
</footer>

<a href="#" class="scrollup" id="scroll-up"><i class="bx bx-up-arrow-alt scrollup__icon"></i></a>

<script src="{% static 'home/assets_shop/js/swiper-bundle.min.js' %}"></script>
<script src="{% static 'home/assets_shop/js/main.js' %}"></script>

{% endblock %}

{% block extra_js %}
    {{ block.super }}

    <script>
    (function() {
        // Size Box
        const sizeBox = document.querySelector('.option-toggle');
        if(sizeBox) {
            sizeBox.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', function() {
                    sizeBox.querySelectorAll('.opt-size').forEach(l => l.classList.remove('is-active'));
                    if(this.checked) this.parentElement.classList.add('is-active');
                });
            });
        }
        // Finish Box
        const finishBox = document.querySelector('.finish-box');
        if(finishBox) {
            finishBox.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', function() {
                    finishBox.querySelectorAll('.opt-finish').forEach(l => l.classList.remove('is-active'));
                    if(this.checked) this.parentElement.classList.add('is-active');
                });
            });
        }
    })();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. Data Object (Safe from formatting issues)
        const priceData = {
        {% for variant in all_variants %}
            '{{ variant.id }}': {
                'p_fine': {{ variant.price_fine_art|default:0|unlocalize }}, 
                'p_alu': {{ variant.price_alu_dibond|default:0|unlocalize }},
                'p_shadow': {{ variant.price_shadow_gap|default:0|unlocalize }},
                'name': "{{ variant.size_name|escapejs }}",
                'recommend_shadow': {{ variant.recommend_shadow_gap|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
        };

        const defaultBorderLarge = {{ page.default_border_large|yesno:"true,false" }};

        const priceDisplay = document.getElementById('product-price');
        const shippingText = document.getElementById('free-shipping-text');
        const sizeRadios = document.querySelectorAll('input[name="size_variant"]');
        const finishRadios = document.querySelectorAll('input[name="finish_variant"]');
        const borderCheckbox = document.getElementById('borders-checkbox');

        const textFine = document.getElementById('text-fine');
        const textAlu = document.getElementById('text-alu');
        const textShadow = document.getElementById('text-shadow');

        function updatePrice() {
            try {
                const selectedSizeInput = document.querySelector('input[name="size_variant"]:checked');
                const selectedFinishInput = document.querySelector('input[name="finish_variant"]:checked');

                if(!selectedSizeInput || !selectedFinishInput) return;

                const variantData = priceData[selectedSizeInput.value];
                if (!variantData) return;

                const finishVal = selectedFinishInput.value;
                
                // --- 1. Identify Current Price (The baseline for diffs) ---
                let currentPrice = 0;
                if (finishVal === 'alu_dibond') currentPrice = variantData.p_alu;
                else if (finishVal === 'shadow_gap') currentPrice = variantData.p_shadow;
                else currentPrice = variantData.p_fine;
                
                // Update Main Price Display
                if(priceDisplay) {
                    priceDisplay.textContent = currentPrice.toFixed(2) + ' €';
                }

                // --- 2. Calculate Diffs Relative to Current Selection ---
                const diffFine = variantData.p_fine - currentPrice;
                const diffAlu = variantData.p_alu - currentPrice;
                const diffShadow = variantData.p_shadow - currentPrice;

                // Formatting Helper: Handles + and - signs automatically
                const fmt = (val) => {
                    if(val === 0) return "";
                    // Note: .toFixed(2) keeps negative sign for negative numbers
                    const sign = val > 0 ? "+" : ""; 
                    return ` (${sign}${val.toFixed(2)}€)`;
                }

                if(textFine) textFine.textContent = `Fine Art Print${fmt(diffFine)}`;
                if(textAlu) textAlu.textContent = `Alu-Composite Frameless${fmt(diffAlu)}`;
                if(textShadow) textShadow.textContent = `Alu-Composite + Shadow Gap Frame${fmt(diffShadow)}`;

                // --- 3. Shipping Text Logic ---
                const isLarge = variantData.name.toUpperCase().includes("60X40"); 
                const isShadow = (finishVal === 'shadow_gap');

                if(shippingText) {
                    if (isLarge || isShadow) {
                        shippingText.style.display = 'inline-block';
                    } else {
                        shippingText.style.display = 'none';
                    }
                }

                // --- 4. Recommended Badge Logic ---
                document.querySelectorAll('.recommended-badge').forEach(el => el.style.display = 'none');
                if (variantData.recommend_shadow && isShadow) {
                    const badge = document.getElementById(`rec-badge-${selectedSizeInput.value}`);
                    if(badge) badge.style.display = 'block';
                }

            } catch (e) { console.log("Update error:", e.message); }
        }

        // --- Handle Size Change (Reset Checkbox defaults) ---
        let previousSize = "";
        function handleSizeChange() {
            const selectedSizeInput = document.querySelector('input[name="size_variant"]:checked');
            if(!selectedSizeInput) return;
            
            const variantData = priceData[selectedSizeInput.value];
            if(!variantData) return;

            const isLarge = variantData.name.toUpperCase().includes("60X40");

            if (selectedSizeInput.value !== previousSize) {
                if (isLarge) {
                    if(borderCheckbox) borderCheckbox.checked = defaultBorderLarge;
                } else {
                    if(borderCheckbox) borderCheckbox.checked = false; 
                }
                previousSize = selectedSizeInput.value;
            }
            updatePrice();
        }

        // Add Listeners
        sizeRadios.forEach(r => r.addEventListener('change', handleSizeChange));
        finishRadios.forEach(r => r.addEventListener('change', updatePrice));

        // Initial Run
        setTimeout(handleSizeChange, 50);
    });
    </script>
{% endblock %}